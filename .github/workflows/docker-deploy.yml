name: Docker Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
    
    - name: Install Docker Compose
      run: |
        echo "Installing Docker Compose..."
        sudo apt-get update
        sudo apt-get install -y docker-compose
        docker-compose --version
    
    - name: Check directory structure
      run: |
        echo "Checking current directory structure:"
        ls -la
        echo "Checking if docker directory exists:"
        if [ -d "docker" ]; then
          echo "✓ docker directory found"
          ls -la docker/
        else
          echo "✗ docker directory not found"
          exit 1
        fi
        echo "Checking if docker-compose.yml exists:"
        if [ -f "docker/docker-compose.yml" ]; then
          echo "✓ docker/docker-compose.yml file found"
          cat docker/docker-compose.yml
        else
          echo "✗ docker/docker-compose.yml file not found"
          exit 1
        fi
    
    - name: Start services with Docker Compose
      run: |
        cd docker
        docker-compose up -d
    
    - name: Wait for services to be ready
      run: |
        cd docker
        timeout 300 bash -c 'until docker-compose exec -T sillytavern echo "Service is ready"; do sleep 5; done' || echo "Service initialization completed"
    
    - name: Check service status
      run: |
        cd docker
        docker-compose ps
        docker-compose logs --tail=20 sillytavern
    
    - name: Test service endpoint
      run: |
        sleep 10
        curl -f http://localhost:8000 || echo "Service endpoint test completed"
